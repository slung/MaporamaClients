var M=M||{};M.Singletons=M.Singletons||{};M.Settings={geoServerUrl:"",geoPlatformUrl:"",geoPlatformCustomer:"",geoRasterServiceUrl:"",defaultPolygonLayer:"polygonLayer",defaultCityLayer:"cityLayer"};M.Engines={OPEN_LAYERS:"openlayers",GOOGLE:"google"};M.useEvents=function(a){M.mix(M.EventDispatcher,a);};M.bind=function(a,b){return function(){return a.apply(b||a,arguments);};};M.mix=function(d,a){var c=a.prototype;a.prototype=new d();a.prototype.constructor=a;for(var b in c){a.prototype[b]=c[b];}};M.JSON={};M.JSON.parse=function(data){if(data){data=data.replace(/\n/g,"");}var result=null;try{result=eval("x = "+data);}catch(err){}return result;};M.util={};M.util.offset=function(b){if(!b.offsetWidth&&!b.style){return;}var a=b.offsetWidth||parseInt(b.style.width,10),j=b.offsetHeight||parseInt(b.style.height,10),h=document.body,g=0,c=0;var k=function(l){if(l===h||l===document.documentElement){return;}g+=l.offsetTop;c+=l.offsetLeft;var e=l.style.transform||l.style.WebkitTransform||l.style.OTransform||l.style.MozTransform||l.style.msTransform;if(e){if(match=e.match(/translate\((.+)px, (.+)px\)/)){g+=parseInt(match[2],10);c+=parseInt(match[1],10);}else{if(match=e.match(/translate3d\((.+)px, (.+)px, (.+)px\)/)){g+=parseInt(match[2],10);c+=parseInt(match[1],10);}else{if(match=e.match(/matrix3d\(([\-\d,\s]+)\)/)){var m=match[1].split(",");g+=parseInt(m[13],10);c+=parseInt(m[12],10);}else{if(match=e.match(/matrix\(.+, .+, .+, .+, (.+), (.+)\)/)){g+=parseInt(match[2],10);c+=parseInt(match[1],10);}}}}}};k(b);try{while(b=b.offsetParent){k(b);}}catch(f){}g+=h.offsetTop;c+=h.offsetLeft;g+=h.parentNode.offsetTop;c+=h.parentNode.offsetLeft;var d=document.defaultView?window.getComputedStyle(h.parentNode,null):h.parentNode.currentStyle;if(h.parentNode.offsetTop!==parseInt(d.marginTop,10)&&!isNaN(parseInt(d.marginTop,10))){g+=parseInt(d.marginTop,10);c+=parseInt(d.marginLeft,10);}return{top:g,left:c,height:j,width:a};};(function(b){function a(){}a.prototype={createXhr:function(c){if(c){this.options=c;}var d=this;if(this.isIE()&&!this.isSameWithOrigin(this.url)){this.xhr=new XDomainRequest();this.xhr.onload=function(){d.onComplete();};this.xhr.onerror=function(){d.onError();};this.xhr.onprogress=function(){};this.xhr.ontimeout=function(){};}else{if(!!window.XMLHttpRequest){this.xhr=new window.XMLHttpRequest();}else{if(!!window.ActiveXObject){this.xhr=new window.ActiveXObject("Microsoft.XMLHTTP");}}}if(!this.xhr){throw new Error("Unable to create XHR object!");}this.xhr.onreadystatechange=function(){if(this.readyState===4){if(this.status==501){d.onSessionTimeout();}else{if(this.status>=400||this.status==0){d.onError();}else{d.onComplete();}}}};this.xhr.onprogress=function(){};this.xhr.ontimeout=function(){};return;},abort:function(){this.xhr.abort();},isIE:function(){if(navigator.appVersion.indexOf("MSIE")!=-1){return true;}return false;},isSameWithOrigin:function(d){if(d.indexOf("http")==-1){return true;}var f=new RegExp("^http(s)?://.*?(/|$)","i");var e=f.exec(d)[0];var c=f.exec(window.location.href)[0];return(c===e);},attachIsAjaxParameter:function(c){var e=false;for(var d=0;d<c.length;d++){if(c.charAt(d)=="?"){c=c+"&isajax=true";e=true;break;}}if(!e){c=c+"?isajax=true";}return c;},send:function(d,c){this.options=c;this.url=this.attachIsAjaxParameter(d);if(!this.xhr){this.createXhr();}this.xhr.open(c.method,this.url,true);this.xhr.timeout=2000000;if(this.xhr.withCredentials!==undefined){if(c.withCredentials){this.xhr.withCredentials=c.withCredentials;}}if(this.xhr.setRequestHeader&&c.headers){for(var e=0;e<c.headers.length;e++){this.xhr.setRequestHeader(c.headers[e].name,c.headers[e].value);}}if(c.data){this.xhr.send(c.data);}else{this.xhr.send(null);}function f(){throw new Error("Loading timeout: "+d);}return this;},onComplete:function(){if(this.options.on.success){this.options.on.success(this.xhr.responseText);}},onError:function(){if(this.options.on.error){this.options.on.error(this.xhr.responseText);}},onSessionTimeout:function(){window.location.href="login";}};b.ajax=function(c,d){return new a().send(c,d);};})(M);(function(b){var a=function(c){this.scriptsToLoad=[];this.baseUrl=c.baseUrl||"";};a.prototype={loadScript:function(e,f,d){var c=document.createElement("script");c.type="text/javascript";if(d){c.id=d.id;}if(c.readyState){c.onreadystatechange=function(){if(c.readyState=="loaded"||c.readyState=="complete"){c.onreadystatechange=null;setTimeout(function(){f();},0);}};}else{c.onload=function(){setTimeout(function(){f();},0);};}c.src=this.baseUrl+e;document.getElementsByTagName("head")[0].appendChild(c);},loadScripts:function(c,d){this.scriptsToLoad=c.concat();this.recursiveLoad(d);},recursiveLoad:function(c){if(this.scriptsToLoad.length==0){c();return;}this.loadScript(this.scriptsToLoad.shift(),b.bind(function(){this.recursiveLoad(c);},this));}};b.ScriptManager=a;b.require=function(c,d,f){var e=new a(d);e.loadScripts(c,f);};})(M);(function(g){var b=function(h){this.settings=g.Settings;h=h||{};this.url=this.settings.geoPlatformUrl;if(h.url){this.url=h.url;}this.key=this.settings.key;if(h.key){this.key=h.key;}this.customer=this.settings.customer;if(h.customer){this.customer=h.customer;}this.ajax=g.ajax;if(h.ajax){this.ajax=h.ajax;}};b.prototype={customFiltersToQueryString:function(o,j){var h="";j=j||"&";var r=0;for(var p in o){if(p.substring(0,6)=="custom"){var k=o[p];if(k.conditions){for(var q=0;q<k.conditions.length;q++){if(k.conditions[q].value&&typeof k.conditions[q].value!="number"){k.conditions[q].value=k.conditions[q].value.replace(/&/g,"%26");}var m=k.conditions[q];var l=m.operator||"or";var n=m.operation||"contains";if(q==0&&r==0){h+=p+"="+l+","+m.field+","+n+","+m.value;}else{h+=j+p+"="+l+","+m.field+","+n+","+m.value;}r++;}}}}return h;},queryStringToCustomFilters:function(w,k){var p=[];var o=w.split(k);for(var q=0;q<o.length;q++){var v=o[q].split("=")[0];var n=o[q].split("=")[1];var j=n.split(",");if(j.length<4){return;}var u="";if(j.length>4){var s=[];for(var q=3;q<j.length;q++){s.push(j[q]);
}u=s.join();}else{u=j[3];}var t=[];var r={operator:j[0],field:j[1],operation:j[2],value:u};t.push(r);var h={group:v,conditions:t};p.push(h);}var m=[];for(var q=0;q<p.length;q++){var l=p[q];m[l.group]=m[l.group]||{};m[l.group].conditions=m[l.group].conditions||[];m[l.group].conditions=m[l.group].conditions.concat(l.conditions);}return m;},shortenUrl:function(k,l){var j=this.url+"shorturl?"+"maporamakey="+this.key;var h={method:"POST",on:{success:g.bind(function(m){if(l){l.apply(this,[g.JSON.parse(m)]);}},this),error:function(m){console.log(m);}},data:k,headers:[{name:"Content-Type",value:"text/plain"}]};if(!this.ajax){throw new Error("Ajax function is not defined");}return this.ajax(j,h);},searchPointsWithFilters:function(p,s){var h=this.url+this.customer+"/tables/"+p+".json?t="+new Date().getTime()+"&maporamakey="+this.key;if(s){if(s.searchQuery&&s.proximity){h+="&searchType=quick;proxy";}else{if(s.searchQuery&&!s.proximity){h+="&searchType=quick";}else{if(!s.searchQuery&&s.proximity){h+="&searchType=proxy";}}}}if(s&&s.distinctColumns&&s.distinctColumns.length>0){h+="&distinctColumns="+s.distinctColumns.join();}if(s&&s.searchQuery){h+="&searchString="+s.searchQuery;}var r="";if(s&&s.sortBy){h+="&sortMode="+s.sortMode;r+=s.sortBy;}if(s&&s.proximity&&s.proximity.latitude&&s.proximity.longitude){if(s.proximity.distance){h+="&searchDistance="+s.proximity.distance;}h+="&searchCenter="+s.proximity.latitude+","+s.proximity.longitude;h+="&showDistance=true";if(s.sortBy instanceof Array&&s.sortBy.length>0){r=s.sortBy.join(";");}else{if(r){r="distance;"+r;}else{r+="distance";}}}if(r){h+="&sortBy="+r;}if(s&&s.filters){var n="&filterFields=";var k="&filterValues=";for(var j=0;j<s.filters.length;j++){n+=s.filters[j].field+";";for(var o=0;o<s.filters[j].values.length;o++){k+=s.filters[j].values[o]+"|";}k=k.slice(0,k.length-1);k+=";";}n=n.slice(0,n.length-1);k=k.slice(0,k.length-1);h+=n+k;}if(s&&s.customFilters){h+="&"+this.customFiltersToQueryString(s.customFilters);}var l=1;if(s.customFilters){for(var q in s.customFilters){l++;}}if(!this.settings.disableActiveFilter){h+="&customFilter"+l+"_and=and,active,yes,";}if(s.cluster){h+="&compact=false";h+="&cluster=true";h+="&clusterType="+s.cluster.clusterType;if(s.cluster.clusterType!="grid"){h+="&clusterShapeTable="+s.cluster.clusterShapeTable;}if(s.zoom){h+="&zoom="+s.zoom;}if(s.cluster.clusterGridCellSize){h+="&clusterGridCellSize="+s.cluster.clusterGridCellSize;}}if(s.bounds){if((s.cluster&&s.cluster.includeBounds)||!s.cluster){h+="&searchType=area";h+="&north="+s.bounds.north;h+="&south="+s.bounds.south;h+="&east="+s.bounds.east;h+="&west="+s.bounds.west;}}if(s.rowCount&&!s.cluster&&!s.bounds){h+="&rowCount="+s.rowCount+"&rowOffset=0";}var m={method:"GET",on:{success:g.bind(function(t){if(s.success){s.success.apply(this,[this.parse(t)]);}},this),error:s.error}};if(!this.ajax){throw new Error("Ajax function is not defined");}return this.ajax(h,m);},loadPoints:function(h,j){return this.searchPointsWithFilters(h,j);},loadPointsFromQuery:function(m,h){var l="";if(h&&h.filters){for(var j=0;j<h.filters.length;j++){var k=h.filters[j];l+="&"+k.field+"="+k.values.join("|");}}this.loadFromQuery(m,g.bind(function(n){if(h.success){h.success.apply(this,[this.parseFromQuery(n)]);}},this),null,l);},abort:function(){if(this.currentAjax){this.currentAjax.abort();}},loadPOIs:function(m,n,o,k){var j=this.url+this.customer+"/catalog/poi.json?maporamakey="+this.key;if(m){j+="&filterFields=metacatid&filterValues=";for(var l=0;l<m.length;l++){j+=m[l]+"|";}j=j.slice(0,j.length-1);}if(n){j+="&searchType=area";j+="&north="+n.top;j+="&south="+n.bottom;j+="&east="+n.right;j+="&west="+n.left;}var h={method:"GET",on:{success:g.bind(function(p){if(o){o.apply(this,[this.parse(p)]);}},this),error:k}};if(!this.ajax){throw new Error("Ajax function is not defined");}this.ajax(j,h);},loadQueryPOIs:function(m,h,p,o,n,q){var j="";if(m){j+="&types=";for(var l=0;l<m.length;l++){j+=m[l]+"|";}j=j.slice(0,j.length-1);}if(q){for(var l=0;l<q.length;l++){var k=q[l];j+="&"+k.field+"="+k.values.join("|");}}if(h){j+="&north="+h.top;j+="&south="+h.bottom;j+="&east="+h.right;j+="&west="+h.left;}this.loadFromQuery(n,p,o,j);},loadFromQuery:function(p,o,k,m){if(!m){m="";}var j=this.url+this.customer+"/queries/"+p+".json?t="+new Date().getTime()+"&maporamakey="+this.key+m;var h={method:"GET",on:{success:g.bind(function(q){if(o){o.apply(this,[g.JSON.parse(q)]);}},this),error:k}};if(!this.ajax){throw new Error("Ajax function is not defined");}var n=function(){this.ajax(j,h);};var l=1500;if(g.Settings.ieLessThan9){setTimeout(g.bind(n,this),l);}else{n.call(this);}},parse:function(o){var k=g.JSON.parse(o);var n=new a(k.Schema);var j=[];if(k.Clusters){return this.parseWithClusters(k,n);}for(var l=0;l<k.Rows.length;l++){var m=k.Rows[l];var h=new c();h.setSchema(n);h.parse(m);j.push(h);}if(!this.settings.disableMultpilePointDetection){j=this.parseMultiplePointDetection(j);}return j;},parseMultiplePointDetection:function(n){var h=[];var o=[];for(var m=0;m<n.length;m++){var q=n[m];var l=false;var p=new f();p.data.push(q);for(var k=m+1;k<n.length;k++){if(o.indexOf(k)==-1&&this.floatsAreEqual(q.lat(),n[k].lat())&&this.floatsAreEqual(q.lon(),n[k].lon())){l=true;o.push(k);p.data.push(n[k]);}}if(l){h.push(p);}else{if(o.indexOf(m)==-1){h.push(q);}}p=null;}return h;},floatsAreEqual:function(j,h){return((Math.round(parseFloat(j)*10000)/10000)==(Math.round(parseFloat(h)*10000)/10000));},parseWithClusters:function(k,n){var j=[];for(var l=0;l<k.NonClusters.length;l++){var m=k.NonClusters[l];var h=new c();h.setSchema(n);h.parse(m);j.push(h);}if(!this.settings.disableMultpilePointDetection){j=this.parseMultiplePointDetection(j);}for(var l=0;l<k.Clusters.length;l++){var m=k.Clusters[l];var h=new e();h.parse(m);j.push(h);}return j;},geocode:function(j,l,o){var l=l||{};if(!l.engine){l.engine=g.Engines.GOOGLE;}switch(l.engine){case g.Engines.GOOGLE:var n=new google.maps.Geocoder();var m={};m.address=j;if(l.bounds){m.bounds=l.bounds;}n.geocode(m,g.bind(function(r,q){if(q==google.maps.GeocoderStatus.OK){if(o){var v=this.filterGeocodingResults(r,l);
if(l.success){l.success.apply(this,[v]);}}else{var t=r[0].geometry.location.lat();var u=r[0].geometry.location.lng();var p=r[0].formatted_address;var s=[r[0].geometry.viewport.getSouthWest().lat(),r[0].geometry.viewport.getSouthWest().lng(),r[0].geometry.viewport.getNorthEast().lat(),r[0].geometry.viewport.getNorthEast().lng()];if(l.success){l.success.apply(this,[t,u,p,s]);}}}},this));break;case g.Engines.OPEN_LAYERS:var k="http://geowebservices.maporama.com/"+g.Settings.customer+"/coder.json?";k+="street="+(j.street||"")+"&";k+="city="+(j.city||"")+"&";k+="zip="+(j.zip||"")+"&";k+="country="+(j.country||"fr")+"&geocoder=maporama&";k+="maporamakey="+g.Settings.key;var h={method:"GET",on:{success:g.bind(function(r){r=g.JSON.parse(r);var t=[];for(var q=0;q<r.length;q++){var s=r[q];t.push({index:q,lat:s.Location.Latitude,lon:s.Location.Longitude,latitude:s.Location.Latitude,longitude:s.Location.Longitude,street:s.StreetName,city:s.City,country:s.Country.toUpperCase(),zip:s.Zip,address:this.formatAddress(s.StreetName,s.City,s.Country.toUpperCase()),bounds:[s.BoundingBox.SouthWest.Latitude,s.BoundingBox.SouthWest.Longitude,s.BoundingBox.NorthEast.Latitude,s.BoundingBox.NorthEast.Longitude]});}var p=(o)?t:t[0];if(l.success){l.success.apply(this,[p]);}},this),error:g.bind(function(p){throw new Error("Unable to geocode!");},this)}};this.ajax(k,h);break;}},createGeocoderAddress:function(l,j){var k={index:l,lat:j.geometry.location.lat(),lon:j.geometry.location.lng(),address:j.formatted_address,bounds:[j.geometry.viewport.getSouthWest().lat(),j.geometry.viewport.getSouthWest().lng(),j.geometry.viewport.getNorthEast().lat(),j.geometry.viewport.getNorthEast().lng()]};var h=this.getCountryFromGoogleGeocoderResponse(j);if(h){k.country=h;}return k;},filterGeocodingResults:function(m,k){var n=[];var j=-1;for(var l=0;l<m.length;l++){if(!k.country||this.isGoogleAddressInCountry(m[l],k.country)){if(!k.bounds||this.isGoogleAddressInBounds(m[l],k.bounds)){j++;var h=this.createGeocoderAddress(j,m[l]);n.push(h);}}}if(this.settings.sortByCountry){n.sort(g.bind(this.countryComparer,this));}return n;},countryComparer:function(j,h){if(!j.country||!h.country||!this.settings.sortByCountry){return 0;}if(j.country.toUpperCase()==this.settings.sortByCountry.toUpperCase()&&h.country.toUpperCase()!=this.settings.sortByCountry.toUpperCase()){return -1;}if(j.country.toUpperCase()!=this.settings.sortByCountry.toUpperCase()&&h.country.toUpperCase()==this.settings.sortByCountry.toUpperCase()){return 1;}return 0;},isGoogleAddressInCountry:function(h,j){if(j.toUpperCase()=="UK"){j="GB";}var k=this.getCountryFromGoogleGeocoderResponse(h);if(!k){return false;}return(k.toUpperCase()==j.toUpperCase());},isGoogleAddressInBounds:function(h,j){var k=new google.maps.LatLng(h.geometry.location.lat(),h.geometry.location.lng());return j.contains(k);},formatAddress:function(l,k,j){var h="";if(l){h=l+", ";}h+=k+", "+j;return h;},reverseGeocode:function(m,j,h){var h=h||{};if(!h.engine){h.engine=g.Engines.GOOGLE;}switch(h.engine){case g.Engines.GOOGLE:var l=new google.maps.Geocoder();var k=new google.maps.LatLng(m,j);l.geocode({latLng:k},g.bind(function(p,o){if(o==google.maps.GeocoderStatus.OK){var n=p[0].formatted_address;var q=p[0].geometry.viewport;var r=this.getCountryFromGoogleGeocoderResponse(p[0]);if(h.success){h.success.apply(this,[n,q,r]);}}},this));}},getCountryFromGoogleGeocoderResponse:function(h){for(var l=0;l<h.address_components.length;l++){var m=h.address_components[l];for(var k=0;k<m.types.length;k++){if(m.types[k]=="country"){return m.short_name;}}}return null;},billing:function(k){if(!k){return;}var l=null;if(this.settings.customTileProvider){if(this.settings.customTileProvider=="maporama"){l="osm";}else{if(this.settings.customTileProvider=="premium"){l="tomtom";}}}var j=this.url+this.customer+"/map.json?lg="+k.lon+"&lt="+k.lat+"&maporamaKey="+this.key;if(l){j+="&provider="+l;}var h={method:"GET",on:{success:g.bind(function(m){},this),error:g.bind(function(m){throw new Error("Billing error!");},this)}};this.ajax(j,h);},itinerary:function(k,m,r){var r=r||{};var q=r.engine||g.Engines.GOOGLE;if(q==g.Engines.GOOGLE){var l=(r.unitSystem&&r.unitSystem=="miles")?google.maps.UnitSystem.IMPERIAL:google.maps.UnitSystem.METRIC;var p=new google.maps.DirectionsService();var n={origin:k,destination:m,travelMode:r.travelMode||google.maps.TravelMode.DRIVING,unitSystem:l};p.route(n,g.bind(function(t,s){if(s==google.maps.DirectionsStatus.OK){if(r.success){r.success.apply(this,[t]);}}else{if(r.error){r.error.apply(this,[t,s]);}}},this));}else{if(q==g.Engines.OPEN_LAYERS){var j=this.url+this.customer+"/itinerary.json?maporamakey="+this.key;var h=r.travelMode||"vehicule";h=(h=="DRIVING")?"vehicule":"pedestrian";j+="&start="+k.longitude+";"+k.latitude;j+="&end="+m.split(",")[1]+";"+m.split(",")[0];j+="&mode="+h;j+="&language="+(r.language||"fr").toLowerCase();var o={method:"GET",on:{success:g.bind(function(s){var t=this.convertItineraryToGoogleFormat(g.JSON.parse(s));if(r.success){r.success(t);}},this),error:function(s){if(r.error){r.error(s);}}}};this.ajax(j,o);}}},convertItineraryToGoogleFormat:function(j){if(!j){return;}j.routes=[{legs:[{start_location:{lat:function(){return j.Segments[0].Start.Latitude;},lng:function(){return j.Segments[0].Start.Longitude;}},end_location:{lat:function(){return j.Polyline[j.Polyline.length-1].Latitude;},lng:function(){return j.Polyline[j.Polyline.length-1].Longitude;}},start_address:j.Segments[0].Name,distance:{value:j.Summary.Distance.Meters,text:j.Summary.Distance.KmLabel},duration:{text:j.Summary.Time.TimeLabel}}]}];var h=[];for(var k=0;k<j.Segments.length;k++){var l=j.Segments[k];h.push({instructions:l.Sentence,distance:{value:l.SegmentSummary.Distance.Meters},start_location:{lat:(function(m){return function(){return m.Start.Latitude;};})(l),lng:(function(m){return function(){return m.Start.Longitude;};})(l)}});}j.routes[0].legs[0].steps=h;return j;},parseFromQuery:function(n){var k=n;var j=[];for(var l=0;l<k.length;
l++){var m=k[l];var h=new d();h.parse(m);j.push(h);}return j;},login:function(j,m,o,n,l){var h={method:"POST",on:{success:g.bind(function(p){if(n){n.apply(this,[g.JSON.parse(p)]);}},this),error:function(p){if(p){l.apply(this,[g.JSON.parse(p)]);}else{throw new Error("Login faild");}}},data:"username="+j+"&password="+m+"&remember="+o};var k=this.url+"login";this.ajax(k,h);return null;},forgotPassword:function(j,m,l){var h={method:"POST",on:{success:g.bind(function(n){if(m){m.apply(this,[g.JSON.parse(n)]);}},this),error:function(n){if(n){l.apply(this,[g.JSON.parse(n)]);}else{throw new Error("Forgot Password failed");}}},data:"username="+j};var k=this.url+"forgot";this.ajax(k,h);return null;},changePassword:function(j,m,o,n,l){var h={method:"POST",on:{success:g.bind(function(p){if(n){n.apply(this,[g.JSON.parse(p)]);}},this),error:function(p){if(n){n.apply(this,null);}}},data:"username="+j+"&oldPassword="+m+"&newPassword="+o};var k=this.url+"motdepasse";this.ajax(k,h);return null;}};var e=function(){this._lat=null;this._lon=null;this.count=0;this.type="cluster";this.id=null;};e.prototype={parse:function(h){this.id=h.Id;this._lat=h.Center.Latitude;this._lon=h.Center.Longitude;this.count=h.Count;this.bounds=[h.MinLat,h.MinLon,h.MaxLat,h.MaxLon];},lat:function(){return this._lat;},lon:function(){return this._lon;}};var c=function(h){this.data={};this.schema=h;this.type="point";};c.prototype={lat:function(){return this.data[this.schema.columnName("lat")];},lon:function(){return this.data[this.schema.columnName("lon")];},city:function(){return this.data[this.schema.columnName("city")];},zip:function(){return this.data[this.schema.columnName("zip")];},name:function(){return this.data[this.schema.columnName("name")];},country:function(){return this.data[this.schema.columnName("country")];},address:function(){return this.data[this.schema.columnName("address")];},getFormatDistance:function(){var k=Number(this.data.distance)/1000;var h=k.toString().split(".");var j=h[0];if(h[1]){j+="."+h[1].substr(0,2);}return j;},setSchema:function(h){this.data={};this.schema=h;},parse:function(h){this.data={};for(var j in h){var k=h[j];this.data[k.columnName]=k.columnValue;}this.formatDistance=this.getFormatDistance();}};var f=function(){this.data=[];this.type="multiplePoint";};f.prototype={lat:function(){if(this.data.length<2){throw ("Multiple point length error!");}return this.data[0].lat();},lon:function(){if(this.data.length<2){throw ("Multiple point length error!");}return this.data[0].lon();},getFormatDistance:function(){if(this.data.length<2){throw ("Multiple point length error!");}return this.data[0].getFormatDistance();}};var d=function(){this.data={};this.type="point";};d.prototype={parse:function(h){this.data=h;},lat:function(){return this.data.latitude;},lon:function(){return this.data.longitude;}};var a=function(h){this.columns=[];if(h){this.parse(h);}};a.prototype={parse:function(h){this.columns=[];for(var j in h.Columns){var k=h.Columns[j];this.columns.push({customName:k.CustomName,dataType:k.DataType,pseudoType:k.PseudoType});}},columnName:function(j){for(var h=0;h<this.columns.length;h++){var k=this.columns[h];if(k.pseudoType==j){return k.customName;}}return null;}};g.GeoPlatform=b;g.MapoAddressPoint=d;})(M);(function(b){var a=function(c){this.namespace=c.customer;this.settings=b.Settings;this.serverUrl=this.settings.cacheServerUrl==null?this.settings.geoServerUrl:this.settings.cacheServerUrl;if(c.url){this.serverUrl=c.url;}this.ajax=b.ajax;if(c.ajax){this.ajax=c.ajax;}this.layers=[];};a.prototype={generateWMS:function(l,h,k,g,d,e,c){var j=this.namespace+":"+l;if(!k){k="image/png";}if(this.settings.cacheServerUrl){j+="_cached";}var m=new OpenLayers.Layer.WMS(h,this.serverUrl+"/wms?",{LAYERS:j,STYLES:e,format:"image/png",transparent:"true",VERSION:"1.1.1",viewparams:g,tiled:"yes"},{opacity:0.75,singleTile:false,tileOptions:{maxGetUrlLength:2048},buffer:0,tileSize:new OpenLayers.Size(256,256),displayOutsideMaxExtent:true});if(d){var f=d.toXMLString();m.mergeNewParams({SLD_BODY:f});m.sld=d;}this.layers[h]=m;return m;},getFeatureInfo:function(g,j,e,o,n,k){var f=Math.pow(2,o);var p=this.layers[g];var l='<ogc:Filter xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc"><ogc:Intersects><ogc:PropertyName>the_geom</ogc:PropertyName><gml:Point srsName="http://www.opengis.net/gml/srs/epsg.xml%234326"><gml:coordinates>{lat},{lon}</gml:coordinates></gml:Point></ogc:Intersects></ogc:Filter>';var d=this.serverUrl+"/wfs?";d+="&REQUEST=GetFeature";d+="&typeName="+p.tableName;d+="&OUTPUTFORMAT=json";d+="&SRS=EPSG:4326";d+="&filter="+l.replace(new RegExp("{lat}","gi"),j).replace(new RegExp("{lon}","gi"),e);var m=this;var c=encodeURI(d);var h={method:"GET",on:{success:function(q){n.apply(m,[q,j,e]);},error:k}};if(!this.ajax){throw new Error("Ajax function is not defined");}this.ajax(c,h);},changePolygonColor:function(g,h,c,l,m){var d=new b.SLDPolygonSymbolizer("#0000FF","#000000",{fillOpacity:1,strokeWidth:4});var e=new b.SLDPolygonSymbolizer("#F0D090","#000000");var j=new b.SLDContainsFilter(h,c,d);var f=new b.SLDRule([j],"selectRule");var k=this.layers[g];k.sld.sldLayers[0].addRule(f);k.mergeNewParams({SLD_BODY:k.sld.toXMLString()});},changeColors:function(d,g){var f=new b.SLDUserLayer(this.namespace+":"+d,g);var e=new b.SLD([f]);var c=this.layers[d];c.mergeNewParams({SLD_BODY:e.toXMLString()});this.oldRules=g;}};b.GeoServer=a;})(M);(function(c){var b=function(d){if(d.engine!=c.Engines.OPEN_LAYERS&&d.engine!=c.Engines.GOOGLE){throw new Error("Wrong value for engine, please use Google or OpenLayers");}this.settings=c.Settings;this.key=this.settings.key;if(d.key){this.key=d.key;}this.customer=this.settings.customer;if(d.customer){this.customer=d.customer;}this.geoServer=new c.GeoServer({customer:this.customer});this.geoPlatform=new c.GeoPlatform({customer:this.customer,key:this.key});this.geoRasterService=new c.GeoRasterService({customer:this.customer,dispatcher:this});this.engine=a.create(d.engine,{dispatcher:this,geoServer:this.geoServer,geoPlatform:this.geoPlatform,geoRasterService:this.geoRasterService});
if(d.autoInit&&d.mapContainer!==null){this.initMap(d.mapContainer,d.mapOptions||d);}};b.prototype={initMap:function(d,e){this.engine.initMap(d,e||{});},boundsIntersect:function(e,d){return this.engine.boundsIntersect(e,d);},computeDistanceBetweenPoints:function(e,d){return this.engine.computeDistanceBetweenPoints(e,d);},enableDisableDragZoom:function(d){this.engine.enableDisableDragZoom(d);},setMarkerForPoint:function(d,e){return this.engine.setMarkerForPoint(d,e);},getPointsInBounds:function(d){return this.engine.getPointsInBounds(d);},getMarkerForPoint:function(d){return this.engine.getMarkerForPoint(d);},getMarkersInFrontendCluster:function(){return this.engine.getMarkersInFrontendCluster();},addMarkerListener:function(d,e,f){this.engine.addMarkerListener(d,e,f);},addListener:function(f,d,e){this.engine.addListener(f,d,e);},addScale:function(){this.engine.addScale();},addSpecialPoint:function(d){return this.engine.addSpecialPoint(d);},getLatLonForPoint:function(d){return this.engine.getLatLonForPoint(d);},removeSpecialPoint:function(d){this.engine.removeSpecialPoint(d);},zoomToMarkers:function(){this.engine.zoomToMarkers();},showPolygonsFromTable:function(d,e){this.showGeoLayer(this.settings.defaultPolygonLayer,d,e);},showGeoLayer:function(g,e,h,f,d){this.engine.showGeoLayer(g,e,h,f,d);},showGeoRasterLayer:function(e,d){d=d||null;this.engine.showGeoRasterLayer(e,d);},removeLayerByName:function(d){this.engine.removeLayerByName(d);},showPoint:function(d){this.engine.showPoint(d);},showHidePoint:function(d,e){this.engine.showHidePoint(d,e);},showPoints:function(d){this.engine.showPoints(d);},showAllPoints:function(){this.engine.showAllPoints();},hideAllPoints:function(){this.engine.hideAllPoints();},getPoints:function(){return this.engine.getPoints();},showPOIs:function(e,d){this.engine.showPOIs(e,d);},showQueryPOIs:function(d){this.engine.showQueryPOIs(d);},loadPOIs:function(d){this.engine.loadPOIs(d);},getBounds:function(d){return this.engine.getBounds(d);},calculateBounds:function(){return this.engine.calculateBounds();},addPOI:function(d){this.engine.addPOI(d);},addPoints:function(e,f,d){this.engine.addPoints(e,f,d);},addDraggablePoint:function(){this.engine.addDraggablePoint();},removeDraggablePoint:function(d){this.engine.removeDraggablePoint(d);},focusDraggablePins:function(){this.engine.focusDraggablePins();},addTileLayer:function(e,d){this.engine.addTileLayer(e,d);},addPoint:function(d){this.engine.addPoint(d);},removePoint:function(d){this.engine.removePoint(d);},addDynamicCirclePoints:function(e,d){this.engine.addDynamicCirclePoints(e,d);},removeAllPoints:function(){this.engine.removeAllPoints();},createMarker:function(d){return this.engine.createMarker(d);},createMarkerIcon:function(d){return this.engine.createMarkerIcon(d);},createPOIIcon:function(d){this.engine.createPOIIcon(d);},pan:function(e,d){this.engine.pan(e,d);},createPopup:function(e,d){return this.engine.createPopup(e,d);},removePopup:function(d){this.engine.removePopup(d);},addPopup:function(d,e){this.engine.addPopup(d,e);},getPopupDOMElement:function(d){return this.engine.getPopupDOMElement(d);},onMap:function(d,f,e){this.engine.onMap(d,f,e);},zoomTo:function(d){this.engine.zoomTo(d);},zoomToPoints:function(d){this.engine.zoomToPoints(d);},setCenter:function(d,e){this.engine.setCenter(d,e);},setExtent:function(d){this.engine.setExtent(d);},setOpacity:function(d,e){this.engine.setOpacity(d,e);},showItinerary:function(d,e){this.engine.showItinerary(d,e);},removeItinerary:function(){this.engine.removeItinerary();},resize:function(){this.engine.resize();},zoomOut:function(){this.engine.zoomOut();},getLonLat:function(d,e){return this.engine.getLonLat(d,e);},getZoom:function(){return this.engine.getZoom();},getCenter:function(){return this.engine.getCenter();},getStreetView:function(){return this.engine.getStreetView();}};var a=function(){};a.create=function(e,d){switch(e){case c.Engines.OPEN_LAYERS:return new c.OpenLayersMap(d);case c.Engines.GOOGLE:return new c.GoogleMap(d);}return null;};c.MaporamaMap=b;})(M);(function(f){var g=function(l){this.template="<StyledLayerDescriptor>{userLayers}</StyledLayerDescriptor>";this.sldLayers=l;};g.prototype={toXMLString:function(){var l="";for(var m=0;m<this.sldLayers.length;m++){l+=this.sldLayers[m].toXMLString();}return(this.template).replace(new RegExp("{userLayers}","gi"),l);}};var j=function(l,m){this.template="<UserLayer><Name>{layerName}</Name><UserStyle><FeatureTypeStyle>{Rules}</FeatureTypeStyle></UserStyle></UserLayer>";this.layerName=l;this.rules=m;};j.prototype={toXMLString:function(){var l=this.template;var m="";for(var n=0;n<this.rules.length;n++){m+=this.rules[n].toXMLString();}l=l.replace(new RegExp("{layerName}","gi"),this.layerName);l=l.replace(new RegExp("{rules}","gi"),m);return l;},getRuleIndexByName:function(l){for(var m=0;m<this.rules.length;m++){if(this.rules[m].name==l){return m;}}return -1;},getRuleByName:function(m){var l=this.getRuleIndexByName(rule.name);if(l>-1){return this.rules[i];}return null;},removeRuleByName:function(m){var l=this.getRuleIndexByName(rule.name);this.rules.splice(l,1);},addRule:function(m){var l=this.getRuleIndexByName(m.name);if(l>-1){this.rules.splice(l,1,m);}else{this.rules=[m].concat(this.rules);}}};var d=function(n,m,l){this.property=n;this.value=m;this.color=l;};d.prototype={toXMLString:function(){var m=new a(this.color,"#000000");var l=new k(this.property,this.value,m);return new e([l]).toXMLString();}};var e=function(m,l){this.template="<Rule>{filters}</Rule>";this.filters=m;this.name=l;};e.prototype={toXMLString:function(){var l=this.template;var m="";for(var n=0;n<this.filters.length;n++){m+=this.filters[n].toXMLString();}l=l.replace(new RegExp("{filters}","gi"),m);return l;}};var k=function(n,m,l){this.template="<Filter><PropertyIsEqualTo><PropertyName>{property}</PropertyName><Literal>{value}</Literal></PropertyIsEqualTo></Filter>";this.property=n;this.value=m;this.symbolizer=l;};k.prototype={toXMLString:function(){var l=this.template;
l=l.replace(new RegExp("{property}","gi"),this.property);l=l.replace(new RegExp("{value}","gi"),this.value);return l+this.symbolizer.toXMLString();}};var c=function(m,l,o,n){this.minMaxTemplate="<Filter><And><PropertyIsLessThanOrEqualTo><PropertyName>{property}</PropertyName><Literal>{max}</Literal></PropertyIsLessThanOrEqualTo><PropertyIsGreaterThanOrEqualTo><PropertyName>{property}</PropertyName><Literal>{min}</Literal></PropertyIsGreaterThanOrEqualTo></And></Filter>";this.minTemplate="<Filter><PropertyIsGreaterThanOrEqualTo><PropertyName>{property}</PropertyName><Literal>{min}</Literal></PropertyIsGreaterThanOrEqualTo></Filter>";this.maxTemplate="<Filter><PropertyIsLessThanOrEqualTo><PropertyName>{property}</PropertyName><Literal>{max}</Literal></PropertyIsLessThanOrEqualTo></Filter>";this.min=m;this.max=l;this.property=o;this.symbolizer=n;};c.prototype={toXMLString:function(){var l=this.minMaxTemplate;if(this.min&&!this.max){l=this.minTemplate;}else{if(!this.min&&this.max){l=this.maxTemplate;}}l=l.replace(new RegExp("{min}","gi"),this.min);l=l.replace(new RegExp("{max}","gi"),this.max);l=l.replace(new RegExp("{property}","gi"),this.property);return l+this.symbolizer.toXMLString();}};var b=function(m,n,l){this.template='<Filter><Contains><PropertyName>the_geom</PropertyName><Point srsName="http://www.opengis.net/def/crs/EPSG/0/4326"><Coordinates>{lon},{lat}</Coordinates></Point></Contains></Filter>';this.lat=m;this.lon=n;this.symbolizer=l;};b.prototype={toXMLString:function(){var l=this.template;l=l.replace(new RegExp("{lon}","gi"),this.lon);l=l.replace(new RegExp("{lat}","gi"),this.lat);return l+this.symbolizer.toXMLString();}};var h=function(l){this.template="<SLDElseFilter/>";this.symbolizer=l;};h.prototype={toXMLString:function(){return this.template+this.symbolizer.toXMLString();}};var a=function(n,m,l){this.template='<PolygonSymbolizer><Fill><CssParameter name="fill">{fillColor}</CssParameter></Fill><Stroke><CssParameter name="stroke">{strokeColor}</CssParameter><CssParameter name="stroke-width">{strokeWidth}</CssParameter></Stroke></PolygonSymbolizer>';this.fillColor=n;this.strokeColor=m;this.strokeWidth=1;if(l){if(l.strokeWidth){this.strokeWidth=l.strokeWidth;}}};a.prototype={toXMLString:function(){var l=this.template;l=l.replace(new RegExp("{fillColor}","gi"),this.fillColor);l=l.replace(new RegExp("{strokeColor}","gi"),this.strokeColor);l=l.replace(new RegExp("{fillOpacity}","gi"),this.fillOpacity);l=l.replace(new RegExp("{strokeWidth}","gi"),this.strokeWidth);return l;}};f.SLD=g;f.SLDUserLayer=j;f.SLDRule=e;f.SLDPropertyRule=d;f.SLDIsEqualToFilter=k;f.SLDContainsFilter=b;f.SLDElseFilter=h;f.SLDIntervalFilter=c;f.SLDPolygonSymbolizer=a;})(M);(function(b){var a=function(c){this.$events={};};a.prototype={on:function(c,d){this.$events[c]=this.$events[c]||[];this.$events[c].push(d);},fire:function(c,g){var f=this.$events[c];for(var d in f){var e=f[d];e.apply(this,[g]);}},detach:function(c,f){var e=this.$events[c];for(var d=0;d<e.length;d++){if(e[d]==f){delete e[d];return;}}return;}};b.EventDispatcher=a;})(M);(function(c){if(typeof OpenLayers!="undefined"){var b=OpenLayers.Map.prototype.moveTo;OpenLayers.Map.prototype.moveTo=function(e,f,d){if(this.getZoom()==this.maxZoom&&f>this.maxZoom){return;}if(f<this.minZoom){return;}if(f>this.maxZoom){f=this.maxZoom;}b.apply(this,arguments);};OpenLayers.Popup.Anchored.prototype.calculateNewPx=function(e){var h=e.offset(this.anchor.offset);var d=this.size||this.contentSize;var g=(this.relativePosition.charAt(0)=="t");h.y+=(g)?-d.h:this.anchor.size.h;var f=(this.relativePosition.charAt(1)=="l");h.x+=(f)?-d.w:this.anchor.size.w;if(this.relativePosition.charAt(1)=="c"){h.x+=-d.w/2;}return h;};var a=OpenLayers.Popup.prototype.setSize;OpenLayers.Popup.prototype.setSize=function(d){a.apply(this,arguments);if(this.div!=null){this.div.style.width="";this.div.style.height="";}if(this.contentDiv!=null){this.contentDiv.style.width="";this.contentDiv.style.height="";}};}})(M);(function(b){var a=function(c){this.map=null;this.polygonsLayers=[];this.markers=[];this.points=[];this.specialPoints=[];this.draggablePoints=[];this.pois={};this.draggablePointsIndex=0;this.dispatcher=c.dispatcher;this.geoPlatform=c.geoPlatform;this.geoServer=c.geoServer;this.geoRasterService=c.geoRasterService||null;};a.prototype={initMap:function(c,e){this.minZoom=e.minZoom||2;this.maxZoom=e.maxZoom||16;this.specialLayerBehind=e.specialLayerBehind;this.map=new OpenLayers.Map({div:c,projection:"EPSG:900936",minZoom:this.minZoom,maxZoom:this.maxZoom,controls:[new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:true},zoomBoxEnabled:true,mouseWheelOptions:{interval:250,cumulative:true}})],displayProjection:new OpenLayers.Projection("EPSG:4326"),maxExtent:new OpenLayers.Bounds(-200375080.34,-200375080.34,200375080.34,200370508.34)});this.map.events.register("click",this,this._onMapClick);this.map.events.register("touchstart",this,this._onMapClick);this.map.events.register("moveend",this,this._onMapMoveEnd);this.map.events.register("zoomend",this,this._onZoomEnd);this.map.events.register("movestart",this,this._onMoveStart);var h="";if(e&&e.attributionTemplate){this.map.addControl(new OpenLayers.Control.Attribution());h=e.attributionTemplate;}if(e&&e.draggablePoints){this.draggablePointsLayer=new OpenLayers.Layer.Vector("Draggable Layer",{renderers:OpenLayers.Layer.Vector.prototype.renderers});this.dragControl=new OpenLayers.Control.DragFeature(this.draggablePointsLayer,{onStart:b.bind(function(){this.putDraggableLayerOnTopOrBottom(true);},this),featureCallbacks:{click:b.bind(function(j){this._onFeatureSelected(j);},this)}});this.map.addControl(this.dragControl);this.dragControl.activate();this.map.addLayer(this.draggablePointsLayer);this.setLayersZIndex();}if(this.geoPlatform.settings.customTileProvider=="maporama"){this.tileLayer=new OpenLayers.Layer.OSM(null,"http://raster.maporama.com/maporama/${z}/${x}/${y}.png",{attribution:h});}else{if(this.geoPlatform.settings.customTileProvider=="premium"){this.tileLayer=new OpenLayers.Layer.OSM(null,"http://raster.maporama.com/premium/${z}/${x}/${y}.png",{attribution:h});
}else{this.tileLayer=new OpenLayers.Layer.OSM(null,null,{attribution:h});}}this.tileLayer.sphericalMercator=true;this.tileLayer.transitionEffect="resize";this.map.addLayers([this.tileLayer]);if(e.bounds&&e.bounds.length==4){this.setExtent(e.bounds);}else{var g=e.startLocation?new OpenLayers.LonLat(e.startLocation[1],e.startLocation[0]):new OpenLayers.LonLat(2,42);var d=e.startZoom?e.startZoom:5;var f=new OpenLayers.Projection("EPSG:4326");g.transform(f,this.map.getProjectionObject());this.map.setCenter(g,d);}this.map.Z_INDEX_BASE.Popup=1500;this.dispatcher.fire("mapReady",[]);return this.map;},addScale:function(){var c=new OpenLayers.Control.ScaleLine({div:document.getElementById("scaleContainer"),geodesic:true,maxWidth:125});this.map.addControl(c);},setLayersZIndex:function(){if(this.specialPointsLayer){var c=200;if(this.specialLayerBehind){c=120;}this.map.setLayerZIndex(this.specialPointsLayer,c);}if(this.pointsLayer){this.map.setLayerZIndex(this.pointsLayer,150);}if(this.poiLayer){this.map.setLayerZIndex(this.poiLayer,100);}if(this.draggablePointsLayer){this.map.setLayerZIndex(this.draggablePointsLayer,50);}this.map.Z_INDEX_BASE.Popup=1500;},showGeoLayer:function(h,f,j,g,e){var d=this.geoServer.generateWMS(f,h,null,j,g,e,this.map);d.tableName=f;var c=this.removeLayerByName(h);this.map.addLayer(d);this.map.setLayerZIndex(d,this.polygonsLayers.length*100);this.setLayersZIndex();this.polygonsLayers.push(d);},showGeoRasterLayer:function(e,d){if(!this.geoRasterService){return;}d=d||{};var f=new OpenLayers.Layer.TMS(e,[""],{getURL:b.bind(function(j){var k=this.map.getZoom();var h=this.map.getResolution();var g=Math.round((j.left-f.maxExtent.left)/(h*f.tileSize.w));var l=Math.round((f.maxExtent.top-j.top)/(h*f.tileSize.h));return this.geoRasterService.getTileUrl(k,g,l,e,d);},this),isBaseLayer:false,maxExtent:new OpenLayers.Bounds(-20037508.3427892,-20037508.3427892,20037508.3427892,20037508.3427892),tileOrigin:new OpenLayers.LonLat(-180,-90),sphericalMercator:true,buffer:0});if(d.minZoom){f.minResolution=this.map.getResolutionForZoom(d.minZoom);}if(d.maxZoom){f.maxResolution=this.map.getResolutionForZoom(d.maxZoom);}var c=this.removeLayerByName(e);f.events.register("tileloaded",f,b.bind(function(g){this.geoRasterService._onTileLoaded();},this));this.map.events.register("zoomstart",this,this.geoRasterService._onChangeZoom);this.map.events.register("click",this,this._onGeoRasterClick);this.map.events.register("mousemove",this,this._onGeoRasterMouseOver);this.map.addLayer(f);if(c>-1){this.map.setLayerZIndex(f,c);}this.polygonsLayers.push(f);},_onGeoRasterMouseOver:function(c){this._fireGeoRasterFeatureEvent(c,"geoRasterMouseOver");},_onGeoRasterClick:function(c){OpenLayers.Event.stop(c);this._fireGeoRasterFeatureEvent(c,"geoRasterClick");},_fireGeoRasterFeatureEvent:function(n,j){var k=(window.event)?window.event.srcElement:n.target;var e=k.id.split("-")[0];var r=this.map.getZoom();var l=this.map.getResolutionForZoom(0);var p=new OpenLayers.Bounds(-20037508.3427892,-20037508.3427892,20037508.3427892,20037508.3427892);var g=new OpenLayers.Pixel(n.x,n.y);var h=this.map.getLonLatFromPixel(g);var o=1<<this.map.getZoom();var q=this.map.calculateBounds(null,l);var c=new OpenLayers.Pixel((1/l*(h.lon-p.left)),(1/l*(p.top-h.lat)));var m=new google.maps.Point(c.x*o,c.y*o);var t=new google.maps.Point(Math.floor(m.x/256),Math.floor(m.y/256));var d=b.util.offset(this.map.div);var s=this.geoRasterService.getFeature(n.x,n.y,r,t.x,t.y,d,e);if(s){var h=this.map.getLonLatFromPixel(g);h.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));var f={properties:s,lat:h.lat,lon:h.lon,x:n.x,y:n.y};this.dispatcher.fire(j,f);}},removeLayerByName:function(c){var e=this.map.layers;for(var d=0;d<e.length;d++){if(e[d].name===c){if(this.geoRasterService){e[d].events.remove("tileloaded");this.map.events.unregister("click",this,this._onGeoRasterClick);this.map.events.unregister("zoomstart",this,this.geoRasterService._onChangeZoom);this.map.events.unregister("mousemove",this,this._onGeoRasterMouseOver);this.geoRasterService._onRemove();}this.map.removeLayer(e[d]);break;}}this.setLayersZIndex();for(var d=0;d<this.polygonsLayers.length;d++){if(this.polygonsLayers[d].name===c){this.polygonsLayers.splice(d,1);return d;}}return -1;},getLayerByName:function(c){var e=this.map.layers;for(var d=0;d<e.length;d++){if(e[d].name===c){return e[d];}}return null;},getDraggablePointsIndex:function(){return this.draggablePointsIndex++;},putDraggableLayerOnTopOrBottom:function(c){if(!this.draggablePointsLayer){return;}if(c){this.map.setLayerZIndex(this.draggablePointsLayer,200);}else{this.map.setLayerZIndex(this.draggablePointsLayer,50);}},addDraggablePoint:function(c){var e=this.getCenter();var f=new OpenLayers.Projection("EPSG:4326");e.transform(f,this.map.getProjectionObject());var h=new OpenLayers.Geometry.Point(e.lon,e.lat);var g=new OpenLayers.Feature.Vector(h);var d=this.getDraggablePointsIndex();g.id=d.toString();g.style={externalGraphic:this.createDraggableMarkerIcon(c),graphicOpacity:1,graphicWith:31,graphicHeight:37,graphicYOffset:-26,cursor:"pointer"};this.draggablePointsLayer.addFeatures(g);},removeDraggablePoint:function(d){if(!d){return;}d=d.details[0];for(var c=0;c<this.draggablePointsLayer.features.length;c++){if(d.id==this.draggablePointsLayer.features[c].id){this.draggablePointsLayer.selectedFeatures=d;this.draggablePointsLayer.removeFeatures(d,{silent:true});this.draggablePointsLayer.destroyFeatures(d);break;}}},focusDraggablePins:function(){this.putDraggableLayerOnTopOrBottom(true);},addTileLayer:function(d,c){if(!d||!c||this.getLayerByName(d)!=null){return;}var e=new OpenLayers.Layer.XYZ(d,c,{sphericalMercator:true,isBaseLayer:false});this.map.addLayer(e);},zoomToMarkers:function(){var c=this.pointsLayer.getDataExtent();if(c){this.map.zoomToExtent(c);}},addPoints:function(e,f,c){if(!this.pointsLayer){this.pointsLayer=new OpenLayers.Layer.Markers("points");this.pointsLayer.events.fallThrough=true;
this.map.addLayer(this.pointsLayer);}this.setLayersZIndex();if(!(c&&c.bybassRemovePoints==true)){this.removeAllPoints();}for(var d=0;d<e.length;d++){this.addPoint(e[d]);}if(f){this.zoomToMarkers();}},showPOIs:function(e,c,d){if(c){this.poiTypes=c;}if(d){this.poiQuery=d;}if(e){this.map.events.register("moveend",this,this.loadPOIs);}else{this.map.events.unregister("moveend",this,this.loadPOIs);}},loadPOIs:function(c){if(!this.poiLayer){this.poiLayer=new OpenLayers.Layer.Markers("pois");this.poiLayer.events.fallThrough=true;this.map.addLayer(this.poiLayer);}this.setLayersZIndex();this.poiLayer.clearMarkers();var d=new OpenLayers.Projection("EPSG:4326");if(c.query){this.geoPlatform.loadQueryPOIs(c.poiTypes,this.map.getExtent().transform(this.map.getProjectionObject(),d),b.bind(function(f){for(var e=0;e<f.length;e++){this.addQueryPOI(f[e]);}this.dispatcher.fire("poisLoaded");},this),null,c.query,c.queryParams);}else{this.geoPlatform.loadPOIs(c.poiTypes,this.map.getExtent().transform(this.map.getProjectionObject(),d),b.bind(function(f){for(var e=0;e<f.length;e++){this.addPOI(f[e]);}},this),null);}},addPOI:function(f){if(!this.poiLayer){this.poiLayer=new OpenLayers.Layer.Markers("pois");this.poiLayer.events.fallThrough=true;this.map.addLayer(this.poiLayer);}var d=new OpenLayers.LonLat(f.lon(),f.lat());var e=new OpenLayers.Projection("EPSG:4326");d.transform(e,this.map.getProjectionObject());var c=new OpenLayers.Marker(d,this.createPOIIcon(f));c.point=f;this.poiLayer.addMarker(c);},addQueryPOI:function(g){if(!this.poiLayer){this.poiLayer=new OpenLayers.Layer.Markers("pois");this.map.addLayer(this.poiLayer);}var e=new OpenLayers.LonLat(g.lon,g.lat);var f=new OpenLayers.Projection("EPSG:4326");e.transform(f,this.map.getProjectionObject());var d=new OpenLayers.Marker(e,this.createPOIIcon(g));d.events.register("click",this,this._onPOIClick);d.events.register("touchstart",this,this._onPOIClick);d.poi=g;d.display(false);this.poiLayer.addMarker(d);var c=g.metacatid;if(!this.pois[c]){this.pois[c]=[];}this.pois[c].push(d);},addSpecialPoint:function(c){if(!this.specialPointsLayer){this.specialPointsLayer=new OpenLayers.Layer.Markers("SpecialPoints");this.specialPointsLayer.events.fallThrough=true;this.map.addLayer(this.specialPointsLayer);}var e=new OpenLayers.LonLat(c.lon(),c.lat());var f=new OpenLayers.Projection("EPSG:4326");e.transform(f,this.map.getProjectionObject());c.special=true;var d=new OpenLayers.Marker(e,this.createMarkerIcon(c));d.events.register("click",this,this._onPointClick);d.events.register("mouseover",this,this._onPointOver);d.events.register("mouseout",this,this._onPointExit);d.point=c;c.marker=d;this.specialPointsLayer.addMarker(d);this.setLayersZIndex();return c;},removeSpecialPoint:function(c){if(!c||!c.marker){return;}this.specialPointsLayer.removeMarker(c.marker);},removeAllSpecialPoints:function(){this.specialPointsLayer.clearMarkers();},getLatLonForPoint:function(c){return{lat:c.lat,lon:c.lon};},addPoint:function(d){if(!this.pointsLayer){this.pointsLayer=new OpenLayers.Layer.Markers("points");this.pointsLayer.events.fallThrough=true;this.map.addLayer(this.pointsLayer);}var c=this.getMarker(d);c.events.register("touchstart",this,this._onPointClick);c.events.register("click",this,this._onPointClick);c.point=d;d.marker=c;this.pointsLayer.addMarker(c);this.markers.push(c);this.points.push(d);},getMarker:function(c){return this.createMarker(c);},createMarker:function(f){if(!this.pointsLayer){this.pointsLayer=new OpenLayers.Layer.Markers("points");this.pointsLayer.events.fallThrough=true;this.map.addLayer(this.pointsLayer);}var d=new OpenLayers.LonLat(f.lon(),f.lat());var e=new OpenLayers.Projection("EPSG:4326");d.transform(e,this.map.getProjectionObject());var c=new OpenLayers.Marker(d,this.createMarkerIcon(f));c.events.register("mouseover",this,this._onPointOver);c.events.register("mouseout",this,this._onPointExit);c.events.register("dblclick",this,this._onPointDblClick);return c;},removePoint:function(c){if(!this.pointsLayer){return;}for(var d=0;d<this.markers.length;d++){if(this.markers[d].point.marker.icon.url==c.marker.icon.url){this.pointsLayer.removeMarker(this.markers[d]);}}for(var d=0;d<this.points.length;d++){if(this.points[d].marker.icon.url==c.marker.icon.url){this.points.splice(d,1);break;}}},removeAllPoints:function(){if(!this.pointsLayer){return;}for(var c=0;c<this.markers.length;c++){this.pointsLayer.removeMarker(this.markers[c]);}this.points=[];this.markers=[];},createMarkerIcon:function(c){var e=this.markerIcon(c);if(c.type!="cluster"){if(!c.special&&e&&e.size&&e.url){return new OpenLayers.Icon(e.url,e.size,e.offset);}else{if(c.marker&&c.marker.icon){if(!c.marker.icon.size.w||!c.marker.icon.size.h){c.marker.icon.size={w:c.marker.icon.size,h:c.marker.icon.size};}var d=new OpenLayers.Size(c.marker.icon.size.w,c.marker.icon.size.h);var f=new OpenLayers.Pixel(-(d.w/2),-d.h);if(c.marker.icon.offset){f=new OpenLayers.Pixel(c.marker.icon.offset.x,c.marker.icon.offset.y);}return new OpenLayers.Icon(c.marker.icon.url,d,f);}}}return new OpenLayers.Icon(e.url,e.size,e.offset);},markerIcon:function(){var c=new OpenLayers.Size(36,36);return{size:c,offset:new OpenLayers.Pixel(-(c.w/2),-c.h),url:"http://mapping.power-cluster.net/mapping/images/m1.png"};},createPOIIcon:function(e){var c=new OpenLayers.Size(36,36);var d=new OpenLayers.Pixel(-(c.w/2),-c.h);return new OpenLayers.Icon("http://www.canadianhotelguide.com/images/poi_title_target_pin.png",c,d);},pan:function(d,c){this.map.pan(d,c);},getPoints:function(){return this.points;},createPopup:function(g,f){var c=null;var e=new OpenLayers.LonLat(f.lon,f.lat);var h=new OpenLayers.Projection("EPSG:4326");e.transform(h,this.map.getProjectionObject());var j={x:10,y:10};if(f.offset){j=f.offset;}if(!f.width){f.width=130;}if(!f.height){f.height=30;}var d={"size":new OpenLayers.Size(0,0),"offset":new OpenLayers.Pixel(j.x,j.y)};c=new OpenLayers.Popup.Anchored("feature",e,new OpenLayers.Size(f.width,f.height),g,d,false);if(f.alignCenter){c.calculateRelativePosition=function(k){return"tc";
};}else{c.calculateRelativePosition=function(k){return"tr";};}c.keepInMap=true;c.panMapIfOutOfView=true;c.autoSize=true;return c;},addMarkerListener:function(c,d,e){c.events.register(d,this,e);},addPopup:function(c){this.map.addPopup(c,true);},removePopup:function(c){this.map.removePopup(c);},getPopupDOMElement:function(c){return c.div;},transformLonLat:function(g,f,e){var d=new OpenLayers.LonLat(g,f);var c=new OpenLayers.Projection(e);d.transform(c,this.map.getProjectionObject());return d;},calculateBounds:function(){var d=this.map.getExtent().transform(this.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));var c={south:d.bottom,west:d.left,north:d.top,east:d.right};return c;},showItinerary:function(l,n){if(!l||l.routes.length<1){return;}var m=n.strokeColor||"#000000";var k=n.strokeWidth||2;var h=n.strokeOpacity||1;if(!this.linesLayer){this.linesLayer=new OpenLayers.Layer.Vector("Lines Layer");this.map.addLayer(this.linesLayer);}this.linesLayer.destroyFeatures();var e=l.Polyline;var g=[];for(var f=0;f<e.length;f++){g.push(new OpenLayers.Geometry.Point(e[f].Longitude,e[f].Latitude).transform(new OpenLayers.Projection("EPSG:4326"),this.map.getProjectionObject()));}var c=new OpenLayers.Geometry.LineString(g);var d={strokeColor:m,strokeOpacity:h,strokeWidth:k};var j=new OpenLayers.Feature.Vector(c,null,d);this.linesLayer.addFeatures([j]);this.map.zoomToExtent(this.linesLayer.getDataExtent());this.dispatcher.fire("itineraryRendered");},removeItinerary:function(){if(this.specialPointsLayer){this.map.setLayerZIndex(this.specialPointsLayer,100);}if(!this.linesLayer){return;}this.linesLayer.destroyFeatures();},showQueryPOIs:function(e){this.hideAllPOIs();for(var d=0;d<e.length;d++){if(this.pois[e[d]]){for(var c=0;c<this.pois[e[d]].length;c++){this.pois[e[d]][c].display(true);}}}},showPoints:function(d){this.hideAllPoints();for(var c=0;c<d.length;c++){this.showPoint(d[c]);}},showPoint:function(c){var d=this.getMarkerForPoint(c);if(d){d.display(true);}},showHidePoint:function(c,e){var d=c.marker;if(!d){d=this.getMarkerForPoint(c);}if(d){d.display(e);}},showAllPoints:function(){this._showHideAllPoints(true);},hideAllPoints:function(){this._showHideAllPoints(false);},hideAllPOIs:function(){for(var d=0;d<this.poiLayer.markers.length;d++){var c=this.poiLayer.markers[d];c.display(false);}},getMarkerForPoint:function(c){for(var e=0;e<this.markers.length;e++){var d=this.markers[e];if(d.point.index!=undefined){if(d.point.index==c.index){return d;}}else{if(d.point==c){return d;}}}return null;},setMarkerForPoint:function(c,d){for(var e=0;e<this.markers.length;e++){if(this.markers[e].point.index!=undefined){if(this.markers[e].point.index==c.index){this.markers[e].icon.setUrl(d.url);this.markers[e].icon.setSize(d.size);return this.markers[e];}}else{if(this.markers[e].point==c){this.markers[e].icon.setUrl(d.icon.url);this.markers[e].icon.setSize(d.icon.size);return this.markers[e];}}}},onMap:function(c,e,d){this.map.events.register(c,d,e);},zoomTo:function(c){this.map.zoomTo(c);},setCenter:function(d,e){var c=new OpenLayers.LonLat(d.lon,d.lat);this.map.setCenter(c);if(e){this.map.zoomTo(e);}},setExtent:function(e){if(!e){return;}var e=new OpenLayers.Bounds(e[1],e[0],e[3],e[2]);var d=new OpenLayers.Projection("EPSG:4326");var c=this.map.getProjectionObject();e.transform(d,c);if(this.getZoom()==this.maxZoom){this.map.zoomTo(this.maxZoom-1);}this.map.zoomToExtent(e);},setOpacity:function(d,e){var c=e||0;if(this.polygonsLayers){this.polygonsLayers[c].setOpacity(d);}},getLonLat:function(c,g){var f=new OpenLayers.Projection("EPSG:4326");var e=this.map.getProjectionObject();var d=new OpenLayers.LonLat(c,g).transform(f,e);return{lat:d.lat,lon:d.lon};},getZoom:function(){return this.map.getZoom();},getCenter:function(){var c=this.map.getCenter();c.transform(this.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));return c;},resize:function(){this.map.updateSize();},zoomOut:function(){this.map.zoomOut();},calculateRadius:function(e,c){for(var d=0;d<c.length;d++){if(e>=c[d].min){if(c[d].max==null){return c[d].radius;}else{if(e<=c[d].max){return c[d].radius;}}}}},computeCircleRadiusIntervals:function(g,e){var c=[];var h=3;var f=3;c.push({min:0,max:100,radius:3});for(var d=1;d<e.length-1;d++){c.push({min:c[d-1].max+1,max:e[d+1],radius:h*d+f});}return c;},addDynamicCirclePoint:function(g,d){var e=new OpenLayers.Geometry.Point(g.lon,g.lat);e.transform(new OpenLayers.Projection("EPSG:4326"),this.map.getProjectionObject());var c=new OpenLayers.Geometry.Point(e.x,e.y);var f=new OpenLayers.Feature.Vector(c,{radius:this.calculateRadius(g.densite_commerciale,d)});f.point=g;this.circlesLayer.addFeatures([f]);},resetDragControl:function(){this.putDraggableLayerOnTopOrBottom(false);if(this.dragControl){this.dragControl.deactivate();this.dragControl.activate();}},computeDistanceBetweenPoints:function(e,c){lonLat1=this.getLatLonForPoint(e);lonLat2=this.getLatLonForPoint(c);var d=new OpenLayers.Projection("EPSG:4326");var e=new OpenLayers.Geometry.Point(lonLat1.lon,lonLat1.lat).transform(d,this.map.getProjectionObject());var c=new OpenLayers.Geometry.Point(lonLat2.lon,lonLat2.lat).transform(d,this.map.getProjectionObject());return e.distanceTo(c);},addDynamicCirclePoints:function(h,f){var k="polygonLayer";var j=0;var g=new OpenLayers.StyleMap({"default":{graphicName:"circle",pointRadius:"${radius}",strokeColor:"#B23600",fillColor:"#FF8A00",fillOpacity:0.7}});var d=this.removeLayerByName(k);this.circlesLayer=new OpenLayers.Layer.Vector("polygonLayer",{styleMap:g});this.handler=new OpenLayers.Handler.Feature(this,this.circlesLayer,{click:this._onCirclePointClick});this.handler.setMap(this.map);this.handler.activate();this.map.addLayer(this.circlesLayer);if(d>-1){this.map.setLayerZIndex(this.circlesLayer,d);}this.setLayersZIndex();this.polygonsLayers.push(this.circlesLayer);j=h[0].densite_commerciale;var c=this.computeCircleRadiusIntervals(j,f);for(var e=0;e<h.length;e++){this.addDynamicCirclePoint(h[e],c);}},_onCirclePointClick:function(c){this.dispatcher.fire("circleclick",c.point);
},_showHideAllPoints:function(d){for(var e=0;e<this.markers.length;e++){var c=this.markers[e];c.display(d);}},_onMapMoveEnd:function(c){this.geoPlatform.billing(this.getCenter());this.resetDragControl();this.dispatcher.fire("boundsChanged",c);},_onZoomEnd:function(c){},_onMapClick:function(c){this.resetDragControl();var e=this.map.getLonLatFromPixel(c.xy);var d=new OpenLayers.Projection("EPSG:4326");e.transform(this.map.getProjectionObject(),d);this.dispatcher.fire("mapClick",{lon:e.lon,lat:e.lat});},_onFeatureInfo:function(d,f,g){var c=b.JSON.parse(d);var e=c.features[0];if(e){e.lat=f;e.lon=g;}this.dispatcher.fire("polygonClick",e);},_onPOIClick:function(d){this.resetDragControl();var c=d.object;var e=c.poi;this.dispatcher.fire("poiClick",[e]);},_onFeatureSelected:function(c){this.putDraggableLayerOnTopOrBottom(true);this.dispatcher.fire("featureSelected",c);},_onFeatureUnselected:function(c){this.dispatcher.fire("featureUnselected",c);},_onPointClick:function(d){this.resetDragControl();var c=d.object;var e=c.point;if(e.type!="cluster"){this.dispatcher.fire("pointClick",[e]);}else{this.dispatcher.fire("clusterClicked",c);}},_onPointOver:function(d){var c=d.object;var e=c.point;this.dispatcher.fire("pointOver",[e]);},_onPointExit:function(c){this.dispatcher.fire("pointExit",null);},_onPointDblClick:function(d){this.resetDragControl();var c=d.object;var e=c.point;this.dispatcher.fire("pointDblClick",[e]);},_onMoveStart:function(c){this.mapCenterBeforeMove=this.map.getCenter();}};b.OpenLayersMap=a;})(M);(function(b){var a=function(c){this.map=null;this.markers=[];this.specialMarkers=[];this.lastBounds=null;this.dispatcher=c.dispatcher;this.geoPlatform=c.geoPlatform;this.geoServer=c.geoServer;this.geoRasterService=c.geoRasterService||null;};a.prototype={initMap:function(d,r){var h=d;var m=r.startLocation?new google.maps.LatLng(r.startLocation[0],r.startLocation[1]):new google.maps.LatLng(48.868206,2.346597);var p=r.startZoom||5;var n=r.hasOwnProperty("disableDefaultUI")?r.disableDefaultUI:false;var k=r.hasOwnProperty("zoomControl")?r.zoomControl:true;var j=r.hasOwnProperty("panControl")?r.panControl:true;var l=r.hasOwnProperty("streetViewControl")?r.streetViewControl:true;var q=r.hasOwnProperty("zoomControlOptions")?r.zoomControlOptions:{};var c=r.hasOwnProperty("panControlOptions")?r.panControlOptions:{};var g=(r.hasOwnProperty("mapType")&&r.mapType)?r.mapType:google.maps.MapTypeId.ROADMAP;var o=(r.hasOwnProperty("mapTypeControl"))?r.mapTypeControl:true;var f=(r.hasOwnProperty("referenceStyle")&&r.referenceStyle)?r.referenceStyle:null;var o=r.hasOwnProperty("mapTypeControl")?r.mapTypeControl:true;var c=r.hasOwnProperty("panControlOptions")?r.panControlOptions:null;if(typeof h=="string"){h=document.getElementById(d);}this.map=new google.maps.Map(h,{zoom:p,minZoom:r.minZoom,maxZoom:r.maxZoom,center:m,mapTypeId:g,disableDefaultUI:n,zoomControl:k,panControl:j,streetViewControl:l,mapTypeControl:o,mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},panControlOptions:c,zoomControlOptions:q,scaleControl:r.scaleControl,scaleControlOptions:r.scaleControlOptions});this.map.setOptions({styles:f});if(typeof this.map.enableKeyDragZoom==="function"&&typeof this.map.enableKeyDragZoom!="undefined"){this.map.enableKeyDragZoom();}google.maps.event.addListener(this.map,"mapoClick",b.bind(function(t){var s=t;if(s.point.type=="cluster"){this.dispatcher.fire("clusterClicked",t);}else{var u={};u.point=s.point;this._onPointClick({marker:u});}},this));google.maps.event.addListener(this.map,"mapoMouseOver",b.bind(function(t){var s=t;if(s.point.type=="cluster"){this.dispatcher.fire("clusterMouseOver",t);}else{var u={};u.point=s.point;this._onPointOver({marker:u});}},this));google.maps.event.addListener(this.map,"mapoMouseOut",b.bind(function(t){var s=t;if(s.point.type=="cluster"){this.dispatcher.fire("clusterMouseOut",t);}else{var u={};u.point=s.point;this._onPointExit({marker:u});}},this));google.maps.event.addListener(this.map,"dragend",b.bind(function(s){this.dispatcher.fire("boundsChanged",[]);},this));google.maps.event.addListener(this.map,"zoom_changed",b.bind(function(){var s=google.maps.event.addListener(this.map,"idle",b.bind(function(t){this.dispatcher.fire("boundsChanged",[]);google.maps.event.removeListener(s);},this));},this));var e=google.maps.event.addListener(this.map,"tilesloaded",b.bind(function(s){this.dispatcher.fire("mapReady",[]);google.maps.event.removeListener(e);},this));this.displayDirections=new google.maps.DirectionsRenderer();this.displayDirections.setOptions({suppressMarkers:true});},enableDisableDragZoom:function(d){if(d){this.map.startDragZoomControl();var c=this.map.getDragZoomObject();google.maps.event.addListener(c,"dragstart",b.bind(function(e){this.dispatcher.fire("dragZoomStarted",e);},this));}else{if(this.map.keyDragZoomEnabled()){this.map.endDragZoomControl();}}},addListener:function(e,c,d){google.maps.event.addListener(e,c,d);},addMarkerListener:function(c,d,e){this.addListener(c,d,e);},enableFrontendClustering:function(d,c){this.markerCluster=new MarkerClusterer(this.map,this.markers,{styles:c.frontendClusterOptions.styles,gridSize:c.frontendClusterOptions.gridSize,maxZoom:c.frontendClusterOptions.maxZoom});},getMarkersInFrontendCluster:function(){if(this.markerCluster){return this.markerCluster.getMarkers();}},disableFrontendClustering:function(){if(this.markerCluster){this.markerCluster.clearMarkers();}},addPoints:function(e,f,c){this.removeAllPoints();for(var d=0;d<e.length;d++){this.addPoint(e[d]);}if(c&&c.useFrontendClustering){this.frontendClusterOptions=c;this.enableFrontendClustering(this.markers,this.frontendClusterOptions);}if(f){this.zoomToPoints(e);}},getPointsInBounds:function(f){var c=[];if(!f){f=this.map.getBounds();}for(var e=0;e<this.markers.length;e++){var g=this.markers[e];var d=g.getPosition();if(f.contains(d)){c.push(g.point);}}return c;},getLatLonForPoint:function(c){return{lat:c.lat(),lon:c.lng()};},getCenter:function(){return this.map.getCenter();
},removeAllPoints:function(){for(var c=0;c<this.markers.length;c++){this.markers[c].point.marker=null;this.markers[c].setMap(null);}this.markers=[];this.disableFrontendClustering();},addPoint:function(c){var d=this.getMarker(c);google.maps.event.addListener(d,"click",b.bind(function(e){this._onPointClick({marker:d});},this));google.maps.event.addListener(d,"mouseover",b.bind(function(e){this._onPointOver({marker:d});},this));google.maps.event.addListener(d,"mouseout",b.bind(function(e){this._onPointExit({marker:d});},this));if(!this.frontendClusterOptions||!this.frontendClusterOptions.useFrontendClustering){d.setMap(this.map);}d.point=c;d.googleMap=this;c.marker=d;this.markers.push(d);},addSpecialPoint:function(c){var d=this.getMarker(c);google.maps.event.addListener(d,"click",b.bind(function(e){this._onPointClick({marker:d});},this));google.maps.event.addListener(d,"mouseover",b.bind(function(e){this._onPointOver({marker:d});},this));google.maps.event.addListener(d,"mouseout",b.bind(function(e){this._onPointExit({marker:d});},this));d.setMap(this.map);d.point=c;d.googleMap=this;c.marker=d;this.specialMarkers.push(d);return c;},createMarker:function(c){var d=new google.maps.Marker();d.setIcon(this.createMarkerIcon(c));d.setPosition(new google.maps.LatLng(c.lat(),c.lon()));var e=this.markerInfo(c);if(e&&e.title){d.setTitle(e.title);}return d;},createMarkerIcon:function(c){var e=this.markerIcon(c);if(c.marker&&c.marker.icon){var g=null;if(c.marker.icon.size&&c.marker.icon.size.width&&c.marker.icon.size.height){g=new google.maps.Size(c.marker.icon.size.width,c.marker.icon.size.height);}var f=null;if(c.marker.icon.scaledSize&&c.marker.icon.scaledSize.width&&c.marker.icon.scaledSize.height){f=new google.maps.Size(c.marker.icon.scaledSize.width,c.marker.icon.scaledSize.height);}var d=null;if(c.marker.icon.anchor&&c.marker.icon.anchor.x!=undefined&&c.marker.icon.anchor.y!=undefined){d=new google.maps.Point(c.marker.icon.anchor.x,c.marker.icon.anchor.y);}return new google.maps.MarkerImage(c.marker.icon.url,g,d,c.marker.icon.offset&&new google.maps.Point(c.marker.icon.offset.x,c.marker.icon.offset.y),f);}var g=null;if(e.size&&e.size.width&&e.size.height){g=new google.maps.Size(e.size.width,e.size.height);}var f=null;if(e.scaledSize&&e.scaledSize.width&&e.scaledSize.height){f=new google.maps.Size(e.scaledSize.width,e.scaledSize.height);}return new google.maps.MarkerImage(e.url,g,null,e.anchor,f);},markerIcon:function(){return"http://www.openlayers.org/dev/img/marker-green.png";},markerInfo:function(c){return null;},calculateBounds:function(){if(!this.map){return;}var d=this.map.getBounds();if(!d){return;}var c={north:d.getNorthEast().lat(),east:d.getNorthEast().lng(),south:d.getSouthWest().lat(),west:d.getSouthWest().lng()};return c;},showPoint:function(c){var d=this.getMarkerForPoint(c);if(d){d.setMap(this.map);}},showGeoRasterLayer:function(d,c){c=c||{};if(!this.geoRasterService){return;}if(!this.GeosRasterListener){this.GeosRasterListener=[];}var e=new google.maps.ImageMapType({getTileUrl:b.bind(function(g,f){return this._getGeoRasterTileUrl(g,f,d,c);},this),tileSize:new google.maps.Size(256,256),isPng:true,name:d,minZoom:(c.minZoom||0),maxZoom:(c.maxZoom||18)});this.removeLayerByName(d);this.map.overlayMapTypes.push(e);this.GeosRasterListener.push(google.maps.event.addDomListener(e,"tilesloaded",b.bind(function(f){this.geoRasterService._onTileLoaded();},this)));this.GeosRasterListener.push(google.maps.event.addDomListener(this.map,"zoom_changed",b.bind(function(f){this.geoRasterService._onChangeZoom();},this)));this.GeosRasterListener.push(google.maps.event.addDomListener(this.map,"click",b.bind(function(f){this._onGeoRasterClick(f,d);},this)));this.GeosRasterListener.push(google.maps.event.addDomListener(this.map,"mousemove",b.bind(function(f){this._onGeoRasterMouseOver(f,d);},this)));},_getGeoRasterTileUrl:function(f,e,d,c){return this.geoRasterService.getTileUrl(e,f.x,f.y,d,c);},_onGeoRasterMouseOver:function(c,d){this._fireGeoRasterFeatureEvent(c,d,"geoRasterMouseOver");},_onGeoRasterClick:function(c,d){this._fireGeoRasterFeatureEvent(c,d,"geoRasterClick");},_fireGeoRasterFeatureEvent:function(k,e,h){var m=this.map.getZoom();var g=this.map.getProjection();var l=1<<this.map.getZoom();var c=g.fromLatLngToPoint(k.latLng);var j=new google.maps.Point(c.x*l,c.y*l);var o=new google.maps.Point(Math.floor(j.x/256),Math.floor(j.y/256));var d=b.util.offset(this.map.getDiv());var n=this.geoRasterService.getFeature(k.pixel.x,k.pixel.y,m,o.x,o.y,d,e);if(n){var f={properties:n,lat:k.latLng.lat(),lon:k.latLng.lng(),x:k.pixel.x,y:k.pixel.y};this.dispatcher.fire(h,f);}},removeLayerByName:function(e){var c=this.map.overlayMapTypes.length;for(var g=0;g<c;g++){var f=this.map.overlayMapTypes.getAt(g);if(f.name===e){if(this.GeosRasterListener){for(var d=0;d<this.GeosRasterListener.length;d++){google.maps.event.removeListener(this.GeosRasterListener[d]);this.GeosRasterListener[d]=null;}}this.map.overlayMapTypes.removeAt(g);this.GeosRasterListener=[];this.geoRasterService._onRemove();break;}}},removePoint:function(c){for(var d=0;d<this.markers.length;d++){if(c.marker==this.markers[d]){this.markers[d].setMap(null);this.markers.splice(d,1);break;}}},removeSpecialPoint:function(c){if(!c){return;}for(var d=0;d<this.specialMarkers.length;d++){if(c.marker==this.specialMarkers[d]){this.specialMarkers[d].setMap(null);this.specialMarkers.splice(d,1);break;}}},showHidePoint:function(c,d){if(!c||!c.marker){return;}c.marker.setVisible(d);},showAllPoints:function(){this._showHideAllPoints(true);},hideAllPoints:function(){this._showHideAllPoints(false);},_showHideAllPoints:function(d){if(this.frontendClusterOptions&&this.frontendClusterOptions.useFrontendClustering){if(d){this.enableFrontendClustering(this.markers,this.frontendClusterOptions);}else{this.disableFrontendClustering();}}else{for(var e=0;e<this.markers.length;e++){var c=this.markers[e];if(d){c.setMap(this.map);}else{c.setMap(null);}}}},getPopupDOMElement:function(c){return c.div_;
},getMarker:function(c){return this.createMarker(c);},getMarkerForPoint:function(c){for(var e=0;e<this.markers.length;e++){var d=this.markers[e];if(d.point.index==c.index){return d;}}return null;},getLonLat:function(c,e){var d=new google.maps.LatLng(e,c);return{lat:d.lat(),lon:d.lng()};},getPoints:function(){var d=[];for(var c=0;c<this.markers.length;c++){d.push(this.markers[c].point);}return d;},pan:function(d,c){this.map.panBy(d,c);},getZoom:function(){return this.map.getZoom();},zoomToPoints:function(d){if(d.length==0){return;}var e=[];for(var c=0;c<d.length;c++){e.push(d[c].marker);}this.zoomToMarkers(e);},zoomToMarkers:function(c){var f=new google.maps.LatLngBounds();var g=c||this.markers;for(var e=0;e<g.length;e++){var d=g[e];f.extend(d.getPosition());}if(this.specialMarkers&&this.specialMarkers.length==1){f.extend(this.specialMarkers[0].getPosition());}this.lastBounds=f;this.map.fitBounds(f);},zoomTo:function(c){this.map.setZoom(c);},getBounds:function(d){if(!d){return;}var c=new google.maps.LatLng(d[0],d[1]);var e=new google.maps.LatLng(d[2],d[3]);return new google.maps.LatLngBounds(c,e);},setExtent:function(c){if(!c){return;}this.map.fitBounds(this.getBounds(c));},setCenter:function(d,c){this.map.setCenter(new google.maps.LatLng(d.lat,d.lon));if(c){this.map.setZoom(c);}},resize:function(){google.maps.event.trigger(this.map,"resize");},createPopup:function(d,c){var f=c.offset||{x:-152,y:-25};var e=new InfoBox({content:d,closeBoxURL:c.closeUrl,closeBoxMargin:c.closeBoxMargin||"11px 10px 0px 0px",alignBottom:true,pixelOffset:new google.maps.Size(f.x,f.y),boxStyle:c.boxStyle});google.maps.event.addListener(e,"domready",c.onDomReady);google.maps.event.addListener(e,"closeclick",c.onCloseClick);return e;},addPopup:function(c,d){if(!d||!d.marker){return;}c.open(this.map,d.marker);},removePopup:function(c){c.close();},showItinerary:function(c,d){if(!c){return;}this.displayDirections.setMap(this.map);this.displayDirections.setDirections(c);var e={polylineOptions:{strokeColor:d.strokeColor}};this.displayDirections.setOptions(e);},boundsIntersect:function(d,c){return d.intersects(c);},removeItinerary:function(){this.displayDirections.setMap(null);},getStreetView:function(){return this.map.getStreetView();},_onPointClick:function(c){this.dispatcher.fire("pointClick",[c.marker.point]);},_onPointExit:function(c){this.dispatcher.fire("pointExit",[c.marker.point]);},_onPointOver:function(c){this.dispatcher.fire("pointOver",[c.marker.point]);}};b.GoogleMap=a;})(M);(function(b){var a=function(c){this.settings=b.Settings;this.tileList=[];this.utfGrid=new b.UtfGrid();c=c||{};this.url=this.settings.geoRasterServiceUrl;if(c.url){this.url=c.url;}this.customer=this.settings.customer;if(c.customer){this.customer=c.customer;}this.dispatcher=c.dispatcher;this.ajax=b.ajax;};a.prototype={getTileUrl:function(h,c,j,g,e){var d=this.url+this.customer+"/"+g+"/"+h+"/"+c+"/"+j+".png";if(e&&e.filters){d+="?";for(var f in e.filters){d+="&"+f+"="+e.filters[f];}}this.tileList.push({src:d,key:this.getTileKey(h,c,j,g)});return d;},getTileKey:function(e,c,f,d){return d+"-"+e+"-"+c+"-"+f;},getFeature:function(k,j,l,n,m,f,g){var h=this.getTileKey(l,n,m,g);var e=document.getElementById(h);if(e){var d=k-b.util.offset(e).left+f.left;var c=j-b.util.offset(e).top+f.top;return this.utfGrid.getFeature(d,c,h);}},_dispose:function(){this.tileList=null;this.tileList=[];this.utfGrid._flushGrid();},_onTileLoaded:function(){var c=this.tileList.length;for(var d=0;d<c;d++){this.utfGrid.getTileGrid(this.tileList[d]);}},_onChangeZoom:function(){this._dispose();},_onRemove:function(){this._dispose();}};b.GeoRasterService=a;})(M);(function(b){var a=function(){this.tilecache=[];this.ajax=b.ajax;};a.prototype={getTileGrid:function(e){if(this.tilecache[e.key]){return;}var d=e.src.replace(".png",".json");var c={method:"GET",on:{success:b.bind(function(f){this._addTile(f,e);},this)}};if(!this.ajax){throw new Error("Ajax function is not defined");}this.ajax(d,c);},getFeature:function(c,g,f){var e=this._getKey(c,g,f);var d=this.tilecache[f].keys[e];if(this.tilecache[f].data[d]){return this.tilecache[f].data[d];}},_getKey:function(c,f,e){var d=this.tilecache[e].grid;if(!d){return;}if((f<0)||(c<0)){return;}if((Math.floor(f)>=256)||(Math.floor(c)>=256)){return;}return this._resolveCode(d[Math.floor((f/4))].charCodeAt(Math.floor((c/4))));},_resolveCode:function(c){if(c>=93){c--;}if(c>=35){c--;}c-=32;return c;},_addTile:function(e,d){var c=b.JSON.parse(e);this.tilecache[d.key]=c;this._indexTile(d);},_flushGrid:function(){this.tilecache=null;this.tilecache=[];},_indexTile:function(f){var d=document.getElementsByTagName("img");var c=d.length;for(var e=0;e<c;e++){if(d[e].src===f.src){d[e].setAttribute("id",f.key);d[e].setAttribute("name",f.key);break;}}}};b.UtfGrid=a;})(M);